# FunASR è¯­éŸ³è¯†åˆ«å¼€å‘æ—¥å¿—

## ğŸ“… å¼€å‘æ—¥æœŸ: 2025-10-16

## ğŸ¯ é¡¹ç›®ç›®æ ‡
å°† FunASR ZH Stream æ¨¡å‹é›†æˆåˆ°ç°æœ‰çš„ audio_capture_v.py ä¸­ï¼Œå®ç°é«˜è´¨é‡çš„å®æ—¶è¯­éŸ³è¯†åˆ«ï¼Œè¦æ±‚ä»£ç ä¿®æ”¹æœ€å°åŒ–ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚

## ğŸ”§ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæ¨¡å‹
- **æ¨¡å‹**: paraformer-zh-streaming (FunASR ZH Stream)
- **ç‰ˆæœ¬**: v2.0.4
- **è®¾å¤‡**: CPU
- **ç‰¹ç‚¹**: æ”¯æŒæµå¼è¯†åˆ«

### å…³é”®æ–‡ä»¶
- `audio_capture_v.py`: ä¸»è¦éŸ³é¢‘æ•è·æ¨¡å—
- `test_funasr.py`: FunASR æµ‹è¯•ç¨‹åº
- `FunASR_DEVELOPMENT_README.md`: æœ¬å¼€å‘æ—¥å¿—

## ğŸš€ å¼€å‘è¿‡ç¨‹ä¸æŒ‘æˆ˜

### é˜¶æ®µ1: åŸºç¡€é›†æˆ
âœ… **æˆåŠŸå®Œæˆ**
- æ·»åŠ  FunASR æ¨¡å‹å¯¼å…¥å’Œæ£€æµ‹
- åœ¨ AudioCapture ç±»ä¸­é›†æˆ FunASR æ¨¡å‹ç®¡ç†
- å®ç° `load_funasr_model()`, `unload_funasr_model()` ç­‰æ–¹æ³•
- åˆ›å»ºæµå¼è¯†åˆ«æ–¹æ³• `listen_realtime_funasr()`

### é˜¶æ®µ2: æµ‹è¯•ç¨‹åºä¿®å¤
âœ… **æˆåŠŸå®Œæˆ**
- ä¿®å¤ `test_funasr.py` ä¸­çš„éº¦å…‹é£è¾“å…¥é—®é¢˜
- åŸç¨‹åºåªèƒ½å¤„ç†é¢„å½•åˆ¶éŸ³é¢‘ï¼Œæ”¹ä¸ºæ”¯æŒå®æ—¶éº¦å…‹é£è¾“å…¥
- å®ç°éŸ³é¢‘ç¼“å†²å’Œæµå¼å¤„ç†

### é˜¶æ®µ3: è¯†åˆ«é€»è¾‘ä¼˜åŒ–
âœ… **é‡å¤§çªç ´**
- **é—®é¢˜**: ç³»ç»Ÿåœ¨ç”¨æˆ·è¯´è¯è¿‡ç¨‹ä¸­å°±"æ€¥ä¸å¯è€"åœ°è¿›è¡Œè¯†åˆ«
- **ç—‡çŠ¶**:
  - "æˆ‘æ˜¯å¤©æ‰" â†’ è¢«è¯†åˆ«ä¸º "æ˜¯å¤©æ‰"
  - "12345678910" â†’ è¢«åˆ‡åˆ†æˆå¤šä¸ªæ•°å­—ç‰‡æ®µ
  - ç”¨æˆ·è¯´è¯ä¸­é€”å°±ä¸æ–­è¾“å‡ºè¯†åˆ«ç»“æœ

## ğŸ’¡ æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ: æ¨¡ä»¿ Vosk çš„ AcceptWaveform æ¨¡å¼

### é—®é¢˜åˆ†æ
é€šè¿‡å¯¹æ¯” audio_capture_v.py ä¸­ Vosk çš„å®ç°ï¼Œå‘ç°å…³é”®å·®å¼‚ï¼š

**Vosk çš„æ­£ç¡®æ¨¡å¼**:
```python
if self._recognizer and self._recognizer.AcceptWaveform(data):
    # åªæœ‰å½“ AcceptWaveform() è¿”å› True æ—¶æ‰è¿›è¡Œè¯†åˆ«
    # è¿™è¡¨ç¤º Vosk åˆ¤æ–­ç”¨æˆ·å·²ç»è¯´å®Œäº†å®Œæ•´çš„è¯
    result = json.loads(self._recognizer.Result())
```

**åŸå§‹ FunASR çš„é”™è¯¯æ¨¡å¼**:
```python
# åœ¨ç”¨æˆ·è¯´è¯è¿‡ç¨‹ä¸­å°±ä¸æ–­è¯†åˆ«
if is_in_speech and current_time - speech_start_time >= min_speech_duration:
    result = self._model.generate(...)  # é”™è¯¯ï¼šæ€¥ä¸å¯è€
```

### ä¼˜åŒ–åçš„æ­£ç¡®æ¨¡å¼
```python
# === æ¨¡ä»¿Voskçš„è¯­éŸ³æ´»åŠ¨æ£€æµ‹é€»è¾‘ ===
if is_speech and not is_speech_segment:
    # å¼€å§‹æ–°çš„è¯­éŸ³æ®µ
    is_speech_segment = True
    speech_start_time = current_time
    speech_segment_audio = []

elif not is_speech and is_speech_segment:
    # è¯­éŸ³å¯èƒ½ç»“æŸï¼Œæ£€æŸ¥é™éŸ³æ—¶é•¿
    silence_duration = current_time - last_speech_time
    speech_duration = current_time - speech_start_time

    # æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœè¯­éŸ³æ®µè¶³å¤Ÿé•¿(>2ç§’)æˆ–é™éŸ³æ—¶é—´è¶³å¤Ÿé•¿ï¼Œå°±ç»“æŸè¯†åˆ«
    should_end = (
        silence_duration >= min_silence_duration or  # é™éŸ³æ—¶é—´è¶³å¤Ÿ
        (silence_duration >= 0.5 and speech_duration >= 2.0)  # è¯­éŸ³è¾ƒé•¿ä¸”çŸ­æš‚åœé¡¿
    )

    if should_end:
        # ç¡®è®¤è¯­éŸ³æ®µç»“æŸï¼Œè¿›è¡Œè¯†åˆ«ï¼ˆæ¨¡ä»¿Voskçš„AcceptWaveformï¼‰
        is_speech_segment = False
        result = self._model.generate(input=np.array(speech_segment_audio), ...)
```

## ğŸ“Š å‚æ•°ä¼˜åŒ–è¿‡ç¨‹

### åˆå§‹å‚æ•° (é—®é¢˜ç‰ˆæœ¬)
```python
speech_energy_threshold = 0.008  # è¿‡äºæ•æ„Ÿ
min_speech_duration = 0.3  # å¤ªçŸ­
min_silence_duration = 0.2  # å¤ªçŸ­ï¼Œå¯¼è‡´è¿‡æ—©æ–­å¥
recognition_interval = 0.5  # é¢‘ç¹è¯†åˆ«
```

### ä¼˜åŒ–å‚æ•° (æœ€ç»ˆç‰ˆæœ¬)
```python
speech_energy_threshold = 0.015  # æé«˜é˜ˆå€¼ï¼Œé™ä½æ•æ„Ÿåº¦
min_speech_duration = 0.4  # ç¡®ä¿æ˜¯çœŸæ­£çš„è¯­éŸ³
min_silence_duration = 0.8  # å¹³è¡¡å“åº”é€Ÿåº¦å’Œå®Œæ•´æ€§
text_similarity_threshold = 0.7  # é€‚åº¦å»é‡ï¼Œé¿å…è¿‡åº¦è¿‡æ»¤
```

### æ™ºèƒ½æ£€æµ‹ç­–ç•¥
- **çŸ­è¯­éŸ³ (< 2ç§’)**: ç­‰å¾… 0.8 ç§’é™éŸ³åè¯†åˆ«
- **é•¿è¯­éŸ³ (â‰¥ 2ç§’)**: åªéœ€ 0.5 ç§’åœé¡¿å°±è¯†åˆ«
- **æ•ˆæœ**: æ—¢ä¿è¯å®Œæ•´æ€§ï¼Œåˆæé«˜å“åº”é€Ÿåº¦

## ğŸ” è°ƒè¯•è¿‡ç¨‹

### é—®é¢˜ç—‡çŠ¶
ç”¨æˆ·åé¦ˆåªæœ‰ `rtf_avg` è¿›åº¦æ¡ï¼Œæ²¡æœ‰è¯†åˆ«ç»“æœ

### è°ƒè¯•æ–¹æ³•
1. **å¯ç”¨ DEBUG æ—¥å¿—**: æŸ¥çœ‹è¯¦ç»†çš„è¯­éŸ³æ®µæ£€æµ‹è¿‡ç¨‹
2. **æ·»åŠ å…³é”®æ—¥å¿—**:
   - `ğŸ¯ å¼€å§‹è¯­éŸ³æ®µ`: ç¡®è®¤è¯­éŸ³æ®µå¼€å§‹
   - `è¯­éŸ³æ®µç»“æŸ`: ç¡®è®¤è¯­éŸ³æ®µç»“æŸ
   - `âš ï¸ è¯­éŸ³æ®µè¿‡çŸ­`: æ£€æŸ¥æ˜¯å¦å› è¯­éŸ³è¿‡çŸ­è¢«è·³è¿‡

### å‘ç°çš„çœŸæ­£åŸå› 
ä¸æ˜¯æ£€æµ‹é—®é¢˜ï¼Œè€Œæ˜¯**é‡å¤æ–‡æœ¬è¢«è¿‡æ»¤æ‰äº†**:
```
2025-10-16 21:03:14 - DEBUG - è·³è¿‡é‡å¤æ–‡æœ¬: ä¸ƒ å ä¸‰ ç‚¹ äº”
```

## ğŸ“ˆ æœ€ç»ˆæ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å“åº”å»¶è¿Ÿ | 0.5ç§’ (æ€¥ä¸å¯è€) | 2-3ç§’ (åˆç†ç­‰å¾…) |
| è¯†åˆ«å®Œæ•´æ€§ | âŒ å¥å­è¢«åˆ‡ç¢ | âœ… å®Œæ•´å¥å­è¯†åˆ« |
| ç”¨æˆ·ä½“éªŒ | âŒ è¯´è¯è¢«æ‰“æ–­ | âœ… è‡ªç„¶æµç•… |
| é‡å¤è¿‡æ»¤ | è¿‡åº¦ä¸¥æ ¼ (0.8) | é€‚åº¦è¿‡æ»¤ (0.7) |

## ğŸ¯ å…³é”®ç»éªŒæ•™è®­

### 1. å­¦ä¹ æˆç†Ÿè§£å†³æ–¹æ¡ˆ
- ä¸è¦é‡æ–°å‘æ˜è½®å­ï¼Œå­¦ä¹  Vosk çš„ AcceptWaveform æ¨¡å¼
- æˆç†Ÿçš„è¯­éŸ³è¯†åˆ«åº“éƒ½æœ‰ç±»ä¼¼çš„è¯­éŸ³æ®µæ£€æµ‹é€»è¾‘

### 2. ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- ç”¨æˆ·æ„Ÿè§‰"æ€¥ä¸å¯è€"æ¯”"ç¨æ…¢å“åº”"æ›´ç³Ÿç³•
- å®å¯å¤šç­‰0.5ç§’ï¼Œä¹Ÿä¸è¦ä¸­é€”æ‰“æ–­ç”¨æˆ·

### 3. å‚æ•°è°ƒä¼˜æ˜¯è‰ºæœ¯
- éœ€è¦åœ¨å“åº”é€Ÿåº¦å’Œè¯†åˆ«å®Œæ•´æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡
- æ™ºèƒ½ç­–ç•¥æ¯”å›ºå®šå‚æ•°æ›´æœ‰æ•ˆ

### 4. è°ƒè¯•çš„é‡è¦æ€§
- çœ‹åˆ°çš„é—®é¢˜ä¸ä¸€å®šæ˜¯çœŸæ­£çš„é—®é¢˜
- è¯¦ç»†çš„æ—¥å¿—æ˜¯è°ƒè¯•çš„å…³é”®å·¥å…·

## ğŸ“ æ–‡ä»¶ç»“æ„

```
Voice_Input/
â”œâ”€â”€ audio_capture_v.py          # ä¸»éŸ³é¢‘æ•è·æ¨¡å— (å·²é›†æˆFunASR)
â”œâ”€â”€ test_funasr.py              # FunASRæµ‹è¯•ç¨‹åº (å·²ä¼˜åŒ–)
â”œâ”€â”€ FunASR_DEVELOPMENT_README.md # æœ¬å¼€å‘æ—¥å¿—
â””â”€â”€ model/fun/                  # FunASRæ¨¡å‹ç›®å½•
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€æµ‹è¯•
```bash
python test_funasr.py
```

### é›†æˆä½¿ç”¨
```python
# åœ¨ audio_capture_v.py ä¸­
capture = AudioCapture()
capture.load_funasr_model()
result = capture.listen_realtime_funasr()
```

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **GPU åŠ é€Ÿ**: å½“å‰ä½¿ç”¨ CPUï¼Œå¯è€ƒè™‘ GPU åŠ é€Ÿæé«˜æ€§èƒ½
2. **å™ªéŸ³æŠ‘åˆ¶**: æ·»åŠ æ›´å¥½çš„å™ªéŸ³è¿‡æ»¤ç®—æ³•
3. **å¤šè¯­è¨€æ”¯æŒ**: æ‰©å±•æ”¯æŒå…¶ä»–è¯­è¨€æ¨¡å‹
4. **å‚æ•°è‡ªé€‚åº”**: æ ¹æ®ç¯å¢ƒå™ªéŸ³è‡ªåŠ¨è°ƒæ•´å‚æ•°

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å¼€å‘æˆåŠŸå®ç°äº† FunASR ä¸ç°æœ‰ç³»ç»Ÿçš„å®Œç¾é›†æˆï¼Œé€šè¿‡æ¨¡ä»¿ Vosk çš„ AcceptWaveform æ¨¡å¼ï¼Œè§£å†³äº†å®æ—¶è¯­éŸ³è¯†åˆ«ä¸­çš„ç”¨æˆ·ä½“éªŒé—®é¢˜ã€‚å…³é”®åœ¨äºç†è§£è¯­éŸ³è¯†åˆ«çš„æœ¬è´¨ï¼š**ç­‰å¾…ç”¨æˆ·è¯´å®Œè¯ï¼Œè€Œä¸æ˜¯æ€¥äºä¸­é€”æ‰“æ–­**ã€‚

è¿™ä¸ªä¼˜åŒ–è¿‡ç¨‹å±•ç¤ºäº†å¦‚ä½•é€šè¿‡å­¦ä¹ å’Œå€Ÿé‰´æˆç†Ÿè§£å†³æ–¹æ¡ˆæ¥å¿«é€Ÿè§£å†³å¤æ‚çš„æŠ€æœ¯é—®é¢˜ã€‚