# 音量映射算法说明

## 🎯 设计目标
- **避免满值**：能量条不会轻易达到100%
- **精细区分**：不同音量级别有明显区别
- **视觉美观**：保留动态变化范围

## 📊 音量分级映射

### 能量范围 → 显示范围

| 能量值范围 | 音量级别 | 显示范围 | 描述 |
|-----------|----------|----------|------|
| < 0.005 | 🔇 极轻声 | 0% | VAD阈值以下，不显示 |
| 0.005-0.008 | 🔈 轻声 | 0-60% | 低于VAD阈值50% |
| 0.008-0.010 | 🔉 正常音量 | 60-100% | 接近VAD阈值 |
| 0.010-0.015 | 🔊 刚听到 | 60-80% | 刚超过VAD阈值 |
| 0.015-0.020 | 🔊 轻度声音 | 70-85% | 轻度语音 |
| 0.020-0.030 | 📢 中度声音 | 80-85% | 中等音量 |
| 0.030-0.060 | 📢 响亮声音 | 83-89% | 响亮语音 |
| 0.060-0.110 | 📣 很响亮 | 86-89% | 很大声 |
| > 0.110 | 📣 很响亮 | 89-92% | 极大声 |

### 关键特点
1. **渐进式映射**：能量越高，显示变化越平缓
2. **避免满值**：最高只显示到92%
3. **保持敏感度**：小声音变化也能反映

## 🔧 算法实现

```python
def calculate_energy_level(energy):
    vad_threshold = 0.010
    excess = energy - vad_threshold

    if excess < vad_threshold * 0.5:      # 0.010-0.015
        energy_level = int(60 + excess * 400)  # 60-80%
    elif excess < vad_threshold * 1:      # 0.015-0.020
        energy_level = int(70 + excess * 300)  # 70-85%
    elif excess < vad_threshold * 2:      # 0.020-0.030
        energy_level = int(80 + excess * 150)  # 80-85%
    elif excess < vad_threshold * 5:      # 0.030-0.060
        energy_level = int(83 + excess * 40)   # 83-89%
    elif excess < vad_threshold * 10:     # 0.060-0.110
        energy_level = int(86 + excess * 18)   # 86-89%
    else:  # > 0.110
        energy_level = min(92, int(89 + (excess - 0.110) * 1))  # 89-92%

    return max(0, min(100, energy_level))
```

## 📈 效果说明

### 日常使用场景
- **轻声说话** (0.015-0.020): 显示70-85%
- **正常交谈** (0.020-0.040): 显示80-87%
- **大声说话** (0.040-0.080): 显示85-89%
- **喊叫** (>0.080): 显示89-92%

### 用户体验
1. **轻声能看见**：即使轻声说话，能量条也有明显显示
2. **变化明显**：不同音量级别有视觉区分
3. **不会满值**：即使在嘈杂环境下也不会满值
4. **保持美观**：动态变化范围合理

## 🎛️ 调试信息

系统会在日志中显示详细的音量变化信息：
```
[🖥️ 音量变化] 能量: 0.02500000 → 82% (中度声音)
[🖥️ 音量变化] 能量: 0.05000000 → 87% (响亮声音)
[🖥️ 音量变化] 能量: 0.10000000 → 89% (很响亮)
```

## 🔧 可调参数

如需调整敏感度，可修改以下参数：
- `vad_threshold = 0.010` (VAD检测阈值)
- 各能量范围的系数 (400, 300, 150, 40, 18, 1)
- 最高显示限制 (92%)

这个设计确保了能量条既能反映真实的语音能量变化，又不会轻易满值，提供更好的用户体验。