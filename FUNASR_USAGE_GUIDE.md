# -*- coding: utf-8 -*-
"""
FunASR语音系统使用说明
集成Excel导出、日志记录和Debug模式
"""

## 📋 功能概述

FunASR语音识别系统现已集成以下功能：

### ✨ 核心功能
- **语音识别**: 基于FunASR的中文语音识别
- **智能数字转换**: 中文数字自动转换为阿拉伯数字
- **序号识别**: 智能识别序号上下文（如"序号二百"→"序号200"）
- **Excel导出**: 纯数字结果自动导出到Excel文件
- **日志记录**: 完整的识别结果记录到日志文件
- **Debug模式**: 调试和生产环境差异化显示

## 🚀 使用方法

### 1. 生产模式（默认）
```bash
python start_funasr.py
```
或
```bash
python main_f.py
```

**特点**:
- 只显示ID和数字: `1: 37.5`
- 非数字结果显示完整文本
- 纯数字自动保存到Excel文件
- 精简的输出信息

### 2. Debug模式
```bash
python main_f.py --debug
```
或
```bash
python main_f.py -d
```

**特点**:
- 显示原始识别文本和转换结果
- 显示完整的识别过程
- 详细的调试信息

## 📁 文件结构

```
Voice_Input/
├── reports/                    # Excel报告目录
│   └── report_20250118_143052.xlsx
├── logs/                       # 日志文件目录
│   └── voice_recognition_20250118_143052.log
├── main_f.py                   # 主程序
├── start_funasr.py            # 快速启动脚本
├── excel_exporter.py          # Excel导出模块
├── funasr_voice_module.py     # FunASR语音识别模块
└── text_processor_clean.py     # 文本处理模块
```

## 📊 Excel导出格式

每行录音会创建一个新的Excel文件，命名格式：`report_yyyymmdd_hhmmss.xlsx`

**Excel列结构**:
| 编号 | 测量值 | 时间戳 | 原始语音 |
|------|--------|--------|----------|
| 1    | 37.5   | 2025-01-18 14:30:52 | 三十七点五 |
| 2    | 100    | 2025-01-18 14:31:15 | 一百 |

## 📝 日志格式

日志文件命名：`voice_recognition_yyyymmdd_hhmmss.log`

**日志内容示例**:
```
2025-01-18 14:30:52,123 - INFO - 识别结果: '三十七点五' -> '37.5' -> 数字: 37.5
2025-01-18 14:31:15,456 - INFO - 识别结果: '今天天气很好' -> '今天天气很好'
2025-01-18 14:31:30,789 - INFO - 识别结果: '序号二百' -> '序号200' -> 数字: 200
```

## 🎯 显示规则

### 生产模式
- **纯数字**: `1: 37.5` (只显示ID和数字)
- **非数字**: `今天天气很好` (显示完整文本)
- **序号数字**: `2: 200` (显示ID和转换后的数字)

### Debug模式
- **纯数字**:
  ```
  三十七点五
  1: 37.5
  ```
- **非数字**: `今天天气很好`
- **序号数字**:
  ```
  序号二百
  2: 200
  ```

## 🔧 数字转换规则

1. **序号上下文**: 包含"序号"、"第"、"页"等关键词时，总是转换为阿拉伯数字
2. **数值大于9**: 数字值大于9时转换为阿拉伯数字
3. **年份识别**: 包含"年"的数字总是转换
4. **纯数字**: 识别为纯数字时，提取并转换为Excel

## ⌨️ 控制命令

### 键盘控制
- **空格键**: 暂停/恢复识别
- **ESC键**: 停止程序

### 语音命令
- **"暂停"**: 暂停识别
- **"继续"/"恢复"**: 恢复识别
- **"停止"/"结束"**: 停止程序

## 📋 示例输出

### 生产模式示例
```
🎤 FunASR语音输入系统
🏭 生产模式
正在初始化...
✅ 初始化成功！

🎯 开始语音识别
请说话...
控制：空格键-暂停/恢复 | ESC键-停止 | 语音命令-暂停/继续/停止
--------------------------------------------------

三十七点五
1: 37.5

序号二百
2: 200

今天天气很好

温度二十五度
3: 25

📊 数据已保存到: ./reports/report_20250118_143052.xlsx

👋 感谢使用FunASR语音输入系统！
```

### Debug模式示例
```
🎤 启动FunASR语音输入系统...
🐛 Debug模式已启用
✅ 初始化成功！

🎯 开始语音识别
请说话...
--------------------------------------------------

三十七点五
1: 37.5

序号二百
2: 200

今天天气很好

温度二十五度
3: 25

📊 数据已保存到: ./reports/report_20250118_143052.xlsx

👋 感谢使用FunASR语音输入系统！
```

## 🛠️ 故障排除

1. **Excel导出失败**: 检查是否安装了`openpyxl`和`pandas`
2. **日志文件未创建**: 检查`logs`目录权限
3. **数字转换错误**: 确保已安装`cn2an`库
4. **语音识别失败**: 检查FunASR模型和FFmpeg环境

## 📦 依赖要求

```bash
pip install funasr onnxruntime cn2an pandas openpyxl pyaudio numpy
```